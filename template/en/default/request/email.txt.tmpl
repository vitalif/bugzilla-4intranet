[%# The contents of this file are subject to the Mozilla Public
  # License Version 1.1 (the "License"); you may not use this file
  # except in compliance with the License. You may obtain a copy of
  # the License at http://www.mozilla.org/MPL/
  #
  # Software distributed under the License is distributed on an "AS
  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
  # implied. See the License for the specific language governing
  # rights and limitations under the License.
  #
  # The Original Code is the Bugzilla Bug Tracking System.
  #
  # The Initial Developer of the Original Code is Netscape Communications
  # Corporation. Portions created by Netscape are
  # Copyright (C) 1998 Netscape Communications Corporation. All
  # Rights Reserved.
  #
  # Contributor(s):     Myk Melez <myk@mozilla.org>
  #                     Jeff Hedlund <jeff.hedlund@matrixsi.com>
  #                     Frédéric Buclin <LpSolit@gmail.com>
  #%]

[% PROCESS global/variables.none.tmpl %]

[% USE Bugzilla %]
[% BLOCK userlink %]<a href="[% Param('user_mailto') %][% u.email | html %]">[% (u.name || u.login) | html %]</a>[% END %]

[% bugidsummary = bug.bug_id _ ': ' _ bug.short_desc %]
[% attidsummary = attachment.id _ ': ' _ attachment.description %]
[% statuses = { '+' => "granted" , '-' => 'denied' , 'X' => "canceled" ,
                '?' => "asked" } %]

[% to_identity = "" %]
[% on_behalf_of = 0 %]
[% IF flag.status == '?' %]
  [% subject_status = "requested" %]
  [% IF flag.setter.id == user.id %]
    [% to_identity = flag.requestee.identity _ " for" %]
  [% ELSE %]
    [% on_behalf_of = 1 %]
    [% IF flag.requestee %][% to_identity = " to " _ flag.requestee.identity %][% END %]
  [% END %]
[% ELSE %]
  [% IF flag.requester %]
    [% to_identity = flag.requester.identity _ "'s request for" %]
  [% END %]
  [% subject_status = statuses.${flag.status} %]
[% END %]
From: [% Param('mailfrom') %]
To: [% to %]
Subject: [% flag.type.name %] [%+ subject_status %]: [[% terms.Bug %] [%+ bug.bug_id %]] [% bug.short_desc %]
[%- IF attachment %] :
  [Attachment [% attachment.id %]] [% attachment.description %][% END %]
X-Bugzilla-Type: request
[% IF Param('useclassification') %]
X-Bugzilla-Classification: [% bug.classification %]
[% END %]
X-Bugzilla-Product: [% bug.product %]
X-Bugzilla-Component: [% bug.component %]
X-Bugzilla-Keywords: [% bug.keywords %]
X-Bugzilla-Severity: [% bug.bug_severity %]
X-Bugzilla-Who: [% user.email %]
X-Bugzilla-Status: [% bug.bug_status %]
X-Bugzilla-Priority: [% bug.priority %]
[% IF bug.assigned_to %]
X-Bugzilla-Assigned-To: [% bug.assigned_to.email %]
[% END %]
[% IF Param('useqacontact') AND bug.qa_contact %]
X-Bugzilla-QA-Contact: [% bug.qa_contact.email %]
[% END %]
X-Bugzilla-Target-Milestone: [% bug.target_milestone %]
[%+ threadingmarker %]
[% USE date %]
[% SET boundary = "--" _ date.now %]
Content-Type: multipart/alternative; boundary=[% boundary %]
MIME-Version: 1.0

--[% boundary %]
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: quoted-printable

[% FILTER quoted_printable %]
[%+ USE wrap -%]
[%- FILTER bullet = wrap(80) -%]
[% IF on_behalf_of %]
[% user.identity %] has reassigned [% flag.setter.identity %]'s request for [% flag.type.name %]
[% to_identity %]:
[% ELSE %]
[% user.identity %] has [% statuses.${flag.status} %] [%+ to_identity %] [%+ flag.type.name %]:
[% END %]

[% terms.Bug %] [%+ bugidsummary %]
[% END %]
[%+ urlbase %]show_bug.cgi?id=[% bug.bug_id %]
[% IF attachment %]

[% FILTER bullet = wrap(80) %]
Attachment [% attidsummary %]
[%- END %]
[%+ urlbase %]attachment.cgi?id=[% attachment.id %]&action=edit
[%- END %]
[%- FILTER bullet = wrap(80) %]

[%-# .defined is necessary to avoid a taint issue in Perl < 5.10.1, see bug 509794. %]
[% IF Bugzilla.cgi.param("comment").defined && Bugzilla.cgi.param("comment").length > 0 %]
------- Additional Comments from [% user.identity %]
[%+ Bugzilla.cgi.param("comment") %]
[% END %]

[%- END %]
[% END %]

--[% boundary %]
Content-Type: text/html; charset=utf-8
Content-Transfer-Encoding: quoted-printable

[% FILTER quoted_printable %]
<body>
<p>
[% IF on_behalf_of %]
 [% PROCESS userlink u=user %] has reassigned [% PROCESS userlink u=flag.setter %]'s request
 for <b>[% flag.type.name %]</b> [% IF flag.requestee %]to [% PROCESS userlink u=flag.requestee %][% END %]:
[% ELSE %]
 [% PROCESS userlink u=user %] has [% statuses.${flag.status} %]
 [% IF flag.status == '?' AND flag.setter.id == user.id %]
  [%+ PROCESS userlink u=flag.requestee %] for
 [% ELSIF flag.status != '?' AND flag.requester %]
  [%+ PROCESS userlink u=flag.requester %]'s request for
 [% END %]
 <b>[% flag.type.name %]</b>:
[% END %]
</p>
<p><a style="font-size: 120%" href="[% urlbase %]show_bug.cgi?id=[% bug.bug_id %]">[% terms.Bug %] [%+ bugidsummary %]</a>
<br><span style="font-size: 90%">(prod:[% bug.product %].[% bug.component %], pri:[% bug.priority %], sev:[% bug.bug_severity %], miles:[% bug.target_milestone %])</span>
[% IF attachment %]
<br><a href="[%+ urlbase %]attachment.cgi?id=[% attachment.id %]&action=edit">Attachment [% attidsummary %]</a>
[% END %]
</p>
[% IF Bugzilla.cgi.param("comment").defined && Bugzilla.cgi.param("comment").length > 0 %]
<p>
Additional Comments from [% PROCESS userlink u=user %]:
<pre style="border-width: 0 0 1px 0; border-style: solid; border-color: #808080; white-space: pre-wrap; word-wrap: break-word; _white-space: pre;">
[%- Bugzilla.cgi.param("comment") | wrap_comment | quoteUrls(bug.bug_id) | absolute_uris -%]
</pre>
</p>
[% END %]
</body>
[% END %]
--[% boundary %]--
